<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ảnh → Sản phẩm → Giá (Demo)</title>
  <style>
    :root{--bg:#0b0c0f;--card:#151821;--fg:#e9edf1;--muted:#9aa4b2;--accent:#6ee7b7}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 system-ui,Segoe UI,Roboto}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    .grid{display:grid;gap:16px;grid-template-columns:1.1fr 1fr}
    .card{background:var(--card);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .title{font-weight:700;font-size:24px;margin:0 0 8px}
    .muted{color:var(--muted)}
    .drop{border:2px dashed #2a3342;border-radius:14px;padding:14px;text-align:center}
    .drop input{display:none}
    .pill{display:inline-flex;align-items:center;gap:8px;background:#1e2430;color:#d6deeb;padding:8px 12px;border-radius:12px}
    .btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;background:#1f2937;color:#fff;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn-primary{background:linear-gradient(90deg,#22d3ee,#34d399)}
    img{max-width:100%;border-radius:12px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .kvs{display:grid;gap:10px}
    .kvs label{font-size:13px;color:var(--muted)}
    .kvs input,.kvs textarea{width:100%;background:#0f131b;border:1px solid #232b3a;color:#e8eef7;border-radius:10px;padding:10px}
    .result{display:grid;gap:10px}
    .result .item{background:#0f131b;border:1px solid #273041;border-radius:12px;padding:12px;display:grid;gap:4px}
    .badge{background:#0b3b2d;color:#8ff0c6;border:1px solid #145f49;border-radius:999px;padding:2px 8px;font-size:12px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
    .hint{font-size:12px;color:var(--muted)}
  </style>
  <!-- Tesseract.js (OCR) & Fuse.js (fuzzy search) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js"></script>
</head>
<body>
  <div class="wrap">
    <h1 class="title">Tự nhận diện sản phẩm từ ảnh &rarr; đối chiếu JSON &rarr; trả giá</h1>
    <p class="muted">Luồng chuẩn: Khách <b>upload ảnh</b> → OCR/rút trích từ khóa (và có thể ảnh ngược) → <b>so khớp</b> với danh mục JSON → <b>hiển thị giá</b>. Demo này chạy <i>offline</i> trên trình duyệt bằng OCR và khớp mờ; sau này có thể gắn thêm API tìm kiếm ảnh (Bing Visual Search / Google Vision) để tăng độ chính xác.</p>

    <div class="grid">
      <!-- LEFT: Image + OCR output -->
      <section class="card">
        <h2 class="title" style="font-size:20px">1) Ảnh sản phẩm</h2>
        <div class="drop" id="drop">
          <input id="imgInput" type="file" accept="image/*" />
          <p class="muted">Kéo thả hoặc <label for="imgInput" class="pill" style="cursor:pointer">Chọn ảnh</label></p>
          <p class="hint">Gợi ý: ảnh nhãn hộp/ống, mặt có chữ càng rõ càng tốt.</p>
        </div>
        <div id="preview" style="margin-top:12px"></div>
        <div class="kvs" style="margin-top:12px">
          <label>Văn bản OCR (có thể chỉnh tay nếu nhận chưa đúng):</label>
          <textarea id="ocrOut" rows="6" placeholder="OCR text will appear here..."></textarea>
          <div class="row">
            <button class="btn" id="btnOcr">Nhận dạng OCR</button>
            <button class="btn" id="btnExtract">Rút trích từ khóa</button>
            <span class="hint">Từ khóa trích xuất sẽ dùng để khớp với JSON.</span>
          </div>
          <div class="row"><span class="pill">Từ khóa:</span> <span id="kw" class="mono"></span></div>
        </div>
      </section>

      <!-- RIGHT: Catalog & Results -->
      <section class="card">
        <h2 class="title" style="font-size:20px">2) Danh mục JSON & kết quả</h2>
        <div class="kvs">
          <label>Tải danh mục sản phẩm (JSON)</label>
          <input type="file" id="jsonInput" accept="application/json" />
          <textarea id="jsonText" rows="6" placeholder='Hoặc dán JSON vào đây...\n[ { "name": "RelyX U200 Automix A2 (xi măng U200)", "price": 123456 }, { "name": "RelyX U200 Automix A3", "price": 123456 } ]'></textarea>
          <div class="row">
            <button class="btn" id="btnLoadJson">Nạp danh mục</button>
            <button class="btn btn-primary" id="btnMatch" disabled>So khớp & lấy giá</button>
          </div>
        </div>
        <h3 style="margin:12px 0 6px">Kết quả</h3>
        <div id="results" class="result"></div>
        <p class="hint">* Mẹo: Nếu một mã có nhiều biến thể màu nhưng <b>cùng giá</b>, bạn có thể lưu 2 dòng cùng <span class="mono">price</span> trong JSON hoặc thêm thuộc tính <span class="mono">variants</span> tùy ý.</p>
      </section>
    </div>

    <section class="card" style="margin-top:16px">
      <h2 class="title" style="font-size:20px">3) Ghi chú triển khai thực tế</h2>
      <ul>
        <li><b>OCR + Heuristics</b>: Tesseract.js trích văn bản (RelyX, U200, 3M, shade A2/A3...).
          Sau đó chuẩn hóa (bỏ dấu, hạ chữ thường, bỏ ký tự thừa) và trích <i>từ khóa ưu tiên</i> (u200, relyx, cement, 3m...).</li>
        <li><b>Fuzzy match</b>: Dùng Fuse.js so khớp mờ với danh mục <span class="mono">name</span> (và alias) trong JSON.</li>
        <li><b>Ảnh ngược (tùy chọn)</b>: Có thể gọi Bing Visual Search / Cloud Vision Product Search để lấy nhãn/ID sản phẩm rồi khớp lại JSON.</li>
        <li><b>Barcode (nếu có)</b>: Nếu ảnh thấy mã vạch, gắn thư viện ZXing/QuaggaJS để đọc trực tiếp → tra danh mục theo <span class="mono">sku/barcode</span>.</li>
      </ul>
    </section>
  </div>

<script>
const $ = (s)=>document.querySelector(s);
const preview = $('#preview');
const ocrOut = $('#ocrOut');
const kwEl = $('#kw');
const btnOcr = $('#btnOcr');
const btnExtract = $('#btnExtract');
const btnLoadJson = $('#btnLoadJson');
const btnMatch = $('#btnMatch');
const results = $('#results');
let currentImageBlob = null;
let catalog = [];
let fuse = null;

// Helpers
const VN_NORM = (s)=> s
  .toLowerCase()
  .normalize('NFD').replace(/[\u0300-\u036f]/g,'') // strip accents
  .replace(/[^a-z0-9\s\-\.\+]/g,' ')
  .replace(/\s+/g,' ').trim();

function extractKeywords(text){
  const t = VN_NORM(text);
  const tokens = new Set();
  // Keywords of interest in nha khoa (tuỳ chỉnh thêm):
  const dict = [
    'u200','relyx','relyx u200','relyx u-200','3m','cement','xi mang','automix','refill','clicker','a1','a2','a3','universal','luting'
  ];
  for(const d of dict){ if(t.includes(VN_NORM(d))) tokens.add(d); }
  // Any token that looks like model codes:
  (t.match(/\b[a-z]{1,3}\d{2,4}\b/g)||[]).forEach(x=>tokens.add(x));
  // Shades A1/A2/A3:
  (t.match(/\ba[1234]\b/g)||[]).forEach(x=>tokens.add(x));
  return Array.from(tokens);
}

function renderImage(file){
  const url = URL.createObjectURL(file);
  currentImageBlob = file;
  preview.innerHTML = `<img src="${url}" alt="preview"/>`;
}

// File inputs
$('#imgInput').addEventListener('change', e=>{
  const f = e.target.files?.[0];
  if(f){ renderImage(f); }
});
$('#jsonInput').addEventListener('change', async e=>{
  const f = e.target.files?.[0];
  if(!f) return;
  const text = await f.text();
  $('#jsonText').value = text;
});

// OCR
btnOcr.addEventListener('click', async()=>{
  if(!currentImageBlob){ alert('Chọn ảnh trước.'); return; }
  btnOcr.disabled = true; btnOcr.textContent = 'Đang OCR...';
  try{
    const { data } = await Tesseract.recognize(currentImageBlob, 'eng');
    ocrOut.value = data.text || '';
  }catch(err){
    console.error(err); alert('OCR lỗi, thử lại ảnh khác.');
  }finally{ btnOcr.disabled=false; btnOcr.textContent='Nhận dạng OCR'; }
});

// Extract keywords
btnExtract.addEventListener('click', ()=>{
  const kws = extractKeywords(ocrOut.value);
  kwEl.textContent = kws.join(', ');
});

// Load catalog JSON
btnLoadJson.addEventListener('click', ()=>{
  try{
    const raw = $('#jsonText').value.trim();
    catalog = raw ? JSON.parse(raw) : [];
  }catch(err){ alert('JSON không hợp lệ'); return; }
  if(!Array.isArray(catalog)){ alert('JSON phải là mảng đối tượng'); return; }

  // Build alias & normalized fields
  for(const it of catalog){
    it._name_norm = VN_NORM(it.name||'');
    // optional alias array
    const al = Array.isArray(it.alias)?it.alias:[];
    it._alias_norm = al.map(VN_NORM);
  }
  fuse = new Fuse(catalog,{
    includeScore:true,
    threshold:0.35,
    keys:[{name:'name',getFn:(it)=>it.name},{name:'alias',getFn:(it)=>it.alias||[]},{name:'_name_norm'},{name:'_alias_norm'}]
  });
  btnMatch.disabled = false;
  alert('Đã nạp danh mục: '+catalog.length+' sản phẩm');
});

// Match
btnMatch.addEventListener('click', ()=>{
  if(!fuse){ alert('Hãy nạp JSON trước.'); return; }
  const kws = extractKeywords(ocrOut.value);
  const q = kws.join(' '); // simple query
  const query = q || VN_NORM(ocrOut.value).split(' ').slice(0,10).join(' ');
  const res = fuse.search(query).slice(0,6);
  results.innerHTML = '';
  if(res.length===0){
    results.innerHTML = '<div class="item">Không tìm thấy. Hãy chỉnh tay từ khóa hoặc danh mục alias.</div>';
    return;
  }
  for(const r of res){
    const it = r.item;
    const price = typeof it.price==='number' ? it.price : (it.price?.value ?? it.price);
    const variants = Array.isArray(it.variants)? it.variants.join(', ') : '';
    const alias = Array.isArray(it.alias)? it.alias.join(', ') : '';
    const extra = [];
    if(variants) extra.push(`Biến thể: <span class="mono">${variants}</span>`);
    if(alias) extra.push(`Alias: <span class="mono">${alias}</span>`);
    const html = `
      <div class="item">
        <div class="row" style="justify-content:space-between">
          <div><strong>${it.name||'Sản phẩm'}</strong></div>
          <span class="badge">điểm ${ (1-r.score).toFixed(2) }</span>
        </div>
        <div>Giá: <strong class="mono">${price!=null? price.toLocaleString('vi-VN')+' ₫' : '—'}</strong></div>
        ${extra.length? `<div class="muted">${extra.join(' · ')}</div>`:''}
      </div>`;
    results.insertAdjacentHTML('beforeend', html);
  }
});

// Seed example JSON for U200 (cùng giá cho 2 màu)
window.addEventListener('load',()=>{
  const demo = [
    { name: '3M RelyX U200 Automix Refill A2 (Xi măng gắn U200)', price: 0, alias: ['RelyX U200 A2','U-200 A2','Xi mang U200 A2'], variants:['A2','A3'] },
    { name: '3M RelyX U200 Automix Refill A3 (Xi măng gắn U200)', price: 0, alias: ['RelyX U200 A3','U-200 A3','Xi mang U200 A3'], variants:['A2','A3'] }
  ];
  $('#jsonText').value = JSON.stringify(demo, null, 2);
});
</script>
</body>
</html>
